Backport of:
From 065334d1ee5b7210e1a0a93c37238c86858f2af7 Mon Sep 17 00:00:00 2001
From: David Lord <davidism@gmail.com>
Date: Wed, 5 Mar 2025 10:08:48 -0800
Subject: [PATCH] attr filter uses env.getattr

---
 src/jinja2/filters.py  | 37 ++++++++++++++++---------------------
 1 file changed, 30 insertions(+), 21 deletions(-)

--- jinja2-2.10.1.orig/jinja2/filters.py
+++ jinja2-2.10.1/jinja2/filters.py
@@ -13,6 +13,7 @@ import sys
 import math
 import random
 import warnings
+import inspect
 
 from itertools import groupby, chain
 
@@ -935,26 +936,31 @@ def do_reverse(value):
 @environmentfilter
 def do_attr(environment, obj, name):
     """Get an attribute of an object.  ``foo|attr("bar")`` works like
-    ``foo.bar`` just that always an attribute is returned and items are not
-    looked up.
+    ``foo.bar``, but returns undefined instead of falling back to ``foo["bar"]``
+    if the attribute doesn't exist
 
     See :ref:`Notes on subscriptions <notes-on-subscriptions>` for more details.
     """
+    # Environment.getattr will fall back to obj[name] if obj.name doesn't exist.
+    # But we want to call env.getattr to get behavior such as sandboxing.
+    # Determine if the attr exists first, so we know the fallback won't trigger.
     try:
-        name = str(name)
-    except UnicodeError:
-        pass
-    else:
-        try:
-            value = getattr(obj, name)
-        except AttributeError:
-            pass
-        else:
-            if environment.sandboxed and not \
-               environment.is_safe_attribute(obj, name, value):
-                return environment.unsafe_undefined(obj, name)
-            return value
-    return environment.undefined(obj=obj, name=name)
+        # This avoids executing properties/descriptors, but misses __getattr__
+        # and __getattribute__ dynamic attrs.
+        getattr_static_py2(obj, name)
+    except AttributeError:
+        # This finds dynamic attrs, and we know it's not a descriptor at this point.
+        if not hasattr(obj, name):
+            return environment.undefined(obj=obj, name=name)
+
+    return environment.getattr(obj, name)
+
+def getattr_static_py2(obj, attr, default=None):
+   """ Mimic getattr_static from Python 3 in Python 2.7. """
+   for cls in inspect.getmro(type(obj)):
+       if attr in cls.__dict__:
+           return cls.__dict__[attr]
+   return getattr(obj, attr, default)
 
 
 @contextfilter
