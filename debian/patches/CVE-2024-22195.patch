From 7dd3680e6eea0d77fde024763657aa4d884ddb23 Mon Sep 17 00:00:00 2001
From: Calum Hutton <calum.hutton@snyk.io>
Date: Thu, 26 Oct 2023 12:08:53 +0100
Subject: [PATCH] xmlattr filter disallows keys with spaces
diff --git a/jinja2/filters.py b/jinja2/filters.py
index 3b0456d..94635a6 100644
--- a/jinja2/filters.py
+++ b/jinja2/filters.py
@@ -9,6 +9,7 @@
     :license: BSD, see LICENSE for more details.
 """
 import re
+import sys
 import math
 import random
 import warnings
@@ -154,12 +155,20 @@ def do_lower(s):
     """Convert a value to lowercase."""
     return soft_unicode(s).lower()
 
+py_vers = sys.version_info.major
+if py_vers == 3:
+    _space_re = re.compile(r"\s", flags=re.ASCII)
+elif py_vers == 2:
+    _space_re =  re.compile(r'[\t\n\x0B\x0C\r\x20]+')
+
+
 
 @evalcontextfilter
 def do_xmlattr(_eval_ctx, d, autospace=True):
     """Create an SGML/XML attribute string based on the items in a dict.
-    All values that are neither `none` nor `undefined` are automatically
-    escaped:
+
+    If any key contains a space, this fails with a ``ValueError``. Values that
+    are neither ``none`` nor ``undefined`` are automatically escaped.
 
     .. sourcecode:: html+jinja
 
@@ -178,12 +187,21 @@ def do_xmlattr(_eval_ctx, d, autospace=True):
 
     As you can see it automatically prepends a space in front of the item
     if the filter returned something unless the second parameter is false.
+        Keys with spaces are not allowed.
     """
-    rv = u' '.join(
-        u'%s="%s"' % (escape(key), escape(value))
-        for key, value in iteritems(d)
-        if value is not None and not isinstance(value, Undefined)
-    )
+    items = []
+
+    for key, value in d.items():
+        if value is None or isinstance(value, Undefined):
+            continue
+
+        if _space_re.search(key) is not None:
+            raise ValueError("Spaces are not allowed in attributes: '%s'" % key)
+
+        items.append('%s="%s"' % (escape(key), escape(value)))
+
+    rv = " ".join(items)
+
     if autospace and rv:
         rv = u' ' + rv
     if _eval_ctx.autoescape:
diff --git a/tests/test_filters.py b/tests/test_filters.py
index 8962ced..911d10a 100644
--- a/tests/test_filters.py
+++ b/tests/test_filters.py
@@ -389,6 +389,12 @@ def test_xmlattr(self, env):
         assert 'bar="23"' in out
         assert 'blub:blub="&lt;?&gt;"' in out
 
+    def test_xmlattr_key_with_spaces(self, env):
+        with pytest.raises(ValueError, match="Spaces are not allowed"):
+            env.from_string(
+                "{{ {'src=1 onerror=alert(1)': 'my_class'}|xmlattr }}"
+            ).render()
+
     def test_sort1(self, env):
         tmpl = env.from_string(
             '{{ [2, 3, 1]|sort }}|{{ [2, 3, 1]|sort(true) }}')
